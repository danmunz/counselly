<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Counsel.ly :: Quickly find a HUD-certified housing counseling agency</title>
  <meta name="description" content="">


  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="chosen/chosen.css">
  <link rel="stylesheet" href="css/style.css">
  
  <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,700' rel='stylesheet' type='text/css'>
  
</head>
<body>
  <!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->

	<header>
		<h1>Counsel.ly</h1>
		<h2>Quickly find a HUD-certified housing counseling agency</h2><br/>
		<span class="hudcredit">+ Data provided by the <a href="http://data.hud.gov/housing_counseling.html">HUD Housing Counselor Web Service API</a></span>
	</header>

<div id="main" role="main">

	<div id="locate">
	<h1>Where are you?</h1>
	<form id="geocoder">
	<input type="text" id="geocoder-input" class="geocodifyInput" autocomplete="off">
	</form>	
	<p>You can enter a physical address above, or <a onclick="alert('Coming soon!')">use your current location</a>.</p>
	</div>
	
	<div id="findfilter">

	<h2 id="madlib">Adjust the filters below to find housing counselors.</h2>

		<div id="leftpanel">
		
			<div id="filters">
			<h2>Distance</h2>
			<p>Only show me counselors within <input type="text" id="distance" name="distance" placeholder="mi" maxlength="2" size="3"></input> mile(s) of me.</p>

			<h2>Services</h2>
			<p>Only show me agencies who provide counseling on:</p>
				<select data-placeholder="begin typing here" class="chzn-select-svc" multiple>
				<option value=""></option> 
				<option value="DFC">DFC</option> 
				<option value="FBC">FBC</option> 
				<option value="FHW">FHW</option> 
				<option value="HIC">HIC</option> 
				<option value="HMC">HMC</option> 
				<option value="NDW">NDW</option> 
				<option value="PPC">PPC</option> 
				<option value="PPW">PPW</option> 
				<option value="RHC">RHC</option> 
				</select>
				
			<h2>Languages</h2>
			<p>Only show me counselors who speak:</p>
				<select data-placeholder="I'm looking for a counselor who speaks…" class="chzn-select-lang" multiple>
				<option value=""></option> 
				<option value="ENG">English</option> 
				<option value="SPA">Español</option> 
				<option value="ASL">American Sign Language</option> 
				</select>
				
				<ol id="listing">
				</ol>

			</div>

		</div>
		
		<div id="rightpanel">
			<div id="map"></div>
		</div>
		
	</div>

</div>

  
  <footer>

  </footer>


  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

  <!--Fancy form fields-->
  <script src="chosen/chosen.jquery.js"></script>
  
  <!--For gmaps to work-->
  <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=true"></script>
  <script src="https://raw.github.com/HPNeo/gmaps/master/gmaps.js"></script>

<!--For address geocoding-->
<script type="text/javascript" src="https://raw.github.com/datadesk/jquery-geocodify/master/jquery.geocodify.js"></script>

<!--Underscore-->
<script type="text/javascript" src="https://raw.github.com/documentcloud/underscore/master/underscore.js"></script>

  <script src="js/agencies.js"></script>

<script type="text/javascript">
	$(document).ready(function () {
		
		//Initialize Geocoder and Chosen forms
		$("#geocoder").geocodify({
			onSelect: function (result) {
				GetLatLongFromAddr(result.formatted_address);
			},
			regionBias: "US",
			initialText: "Begin typing here to find an address or zip code."
		});
		$(".chzn-select-svc").chosen();
		$(".chzn-select-lang").chosen();
		
		//Initialize some global variables
		var myaddress = "";
		var circleonce = false;
		results = [];
		
		//Catch changes in distance
		$('#distance').keyup(function () {
			listUpdater();
			mapUpdater();
		});
		
		//Catch chosen selections
		$(".chzn-select-svc,.chzn-select-lang").chosen().change(function () {
			listUpdater();
			mapUpdater();
		});

		//UPDATE THE ARRAY 'RESULTS' WITH RESULTS THAT MATCH THE FILTERS
		function listUpdater() {

			//Grab form inputs and store them as values			
			var mapradius = Number($('#distance').val()) * 1609.34;
			var svcs = $(".chzn-select-svc").val();
			var langs = $(".chzn-select-lang").val();
						
			//Clear the results array
			results = []; 
			
			//Clear the map circle, if there is one already
			if (circleonce) {
				circle.setMap(null);
			}
			
			zoomscaler(Number($('#distance').val())); //Re-zoom the map to fit it, roughly
			
			map.setCenter(currentpos.getPosition().lat(), currentpos.getPosition().lng()); //Re-center the map around the original address marker
			circle = map.drawCircle({ //Draw a new circle representing the entered radius
				lat: map.getCenter().lat(),
				lng: map.getCenter().lng(),
				strokeWeight: 0,
				fillColor: '#9aaeaf',
				fillOpacity: 0.4,
				radius: mapradius
			});
			circleonce = true; //Indicate that there's an existing circle now
						
			//Add eligible agencies to the results array
			$.each(hudagencies.features, function (i, agency) {
				
				//Calculate the distance each one is from the original address marker
				var distance = calcDistance(currentpos.getPosition().lat(), currentpos.getPosition().lng(), parseFloat(agency.agc_ADDR_LATITUDE), parseFloat(agency.agc_ADDR_LONGITUDE));
				
				//Add any within-range centers to the 'results' array
				if (distance <= mapradius/1609.34){
				results.push(agency);
				} //Add any centers within range to 'results'
				
				return results;
					
			});
			
			console.log("After filtering just for distance there are " + results.length + " results.");
			
			if (svcs !== null){
				$.each(svcs, function (j, svc) { //Check if it matches the services selected
					results = _.filter(results, function (agency) {return agency.services.indexOf(svc) !== -1;});
				});
			}else{
				svcs = ["all services"];
			}

			console.log("After filtering for distance and service there are " + results.length + " results.");
			
			if (langs !== null){
				$.each(langs, function (k, lang) { //Check if it matches the languages selected
					results = _.filter(results, function (agency) {return agency.languages.indexOf(lang) !== -1;});
				});
			}else{
				langs = ["any language"];
			}
			
			console.log("After filtering for distance, service and language there are " + results.length + " results.");
			
			if (mapradius == 0){
				$('#madlib').html('Adjust the filters below to find housing counselors.');
			}else{
				$('#madlib').html('There are <span class="resultsnum">' + results.length + '</span> counseling agencies within <span class="radius">' + Math.round(mapradius/1609.34) + 'mi</span> who know about <span class="services">' + svcs.join(' and ') + '</span> and speak <span class="languages">' + langs.join(' and ') + '</span>.');
			}

			//Sort the results by distance
			results = _.sortBy(results, function(result){
			return calcDistance(currentpos.getPosition().lat(), currentpos.getPosition().lng(), parseFloat(result.agc_ADDR_LATITUDE), parseFloat(result.agc_ADDR_LONGITUDE));
			});
			
			//Hand off your sorted array of results
			return(results);
			
		}
		
		//DISPLAY THE UPDATED ARRAY ON THE LIST AND MAP
		function mapUpdater() {
						
			$('#listing').empty();
					
			$.each(results, function(i, agency){
			
				$('#listing').append('<li id="' + agency.agcid + '" class="result ' + agency.services.replace(/\,/g, ' ') + ' ' + agency.languages.replace(/\,/g, ' ') + '"><span class="result-title">' + agency.nme + '</span><span class="result-address-phone">'+ agency.adr1 + ' ' + agency.adr2 + '<br/>' + agency.city + ' ' + agency.statecd + ' ' + agency.zipcd + '<br/><a href="PHONE" class="phone">'+ agency.phone1 + '</a></span><span class="result-distance">about '+calcDistance(currentpos.getPosition().lat(), currentpos.getPosition().lng(), parseFloat(agency.agc_ADDR_LATITUDE), parseFloat(agency.agc_ADDR_LONGITUDE))+' mi away | <a href="URL" target="_blank">directions</a></span>					<span class="result-flags"></span></li>');
					
					//Add language flags
					var langs = agency.languages.split(",");				
					$.each(langs, function(j, language){
						$('#'+agency.agcid+' .result-flags').append('<span class="result-flag '+language+'"></span>');
					});
					
					//Add URL or email, if there
					if (agency.weburl.toUpperCase() != "HTTP://N/A"){
						$('#'+agency.agcid+' .result-title').wrap('<a href="'+agency.weburl+'">');
					}else if (agency.email.toUpperCase() != "N/A"){
						$('#'+agency.agcid+' .result-title').wrap('<a href="mailto:'+agency.email+'">');					
					}
				
				resultmarker = map.addMarker({ //drop a pin
					lat: agency.agc_ADDR_LATITUDE,
					lng: agency.agc_ADDR_LONGITUDE,
					animation: google.maps.Animation.DROP,
					title: agency.nme,
					infoWindow: {
						content: '<span class="result-title">' + agency.nme + '</span><span class="result-address-phone">'+ agency.adr1 + ' ' + agency.adr2 + '<br/>' + agency.city + ' ' + agency.statecd + ' ' + agency.zipcd + '<br/><a href="PHONE" class="phone">'+ agency.phone1 + '</a></span><span class="result-distance">about '+calcDistance(currentpos.getPosition().lat(), currentpos.getPosition().lng(), parseFloat(agency.agc_ADDR_LATITUDE), parseFloat(agency.agc_ADDR_LONGITUDE))+' mi away | <a href="URL" target="_blank">directions</a></span>'
					},
					mouseover: function (e) {
						$('#' + agency.agcid).css('background', 'beige');
					},
					mouseout: function (e) {
						$('#' + agency.agcid).css('background', 'transparent');
					}
				});

			});
		
		}
			
	}); //end document.ready

	function GetLatLongFromAddr(myaddress) { //Get lat/long from entered address
		GMaps.geocode({
			address: myaddress,
			callback: function (results, status) {
				if (status == 'OK') {

					$('#locate').slideToggle(); //hide step 1
					$('#findfilter').slideToggle(); //show step 2

					map = new GMaps({
						div: '#map',
						zoom: 3,
						lat: 39.50,
						lng: -98.35,
						enableNewStyle: true
					});

					var latlng = results[0].geometry.location;
					map.setCenter(latlng.lat(), latlng.lng()); //re-center the map
					map.setZoom(10); //zoom in
					currentpos = map.addMarker({ //drop a pin
						lat: latlng.lat(),
						lng: latlng.lng(),
						animation: google.maps.Animation.DROP,
						icon: "http://www.melinanina.com/_/rsrc/1357985119821/home/google-maps-pin-blue-hi.png?height=41&width=49"
					});
				} else {
					alert('Something went wrong. Try again.');
				}
			}
		});
	}

	function calcDistance(fromLat, fromLng, toLat, toLng) { //Calculate distance between two lat/long pairs in miles, and round it
		return Math.round(google.maps.geometry.spherical.computeDistanceBetween(
			new google.maps.LatLng(fromLat, fromLng), new google.maps.LatLng(toLat, toLng)) * 0.000621371);
	}

	function zoomscaler(number) { //Get lat/long from entered address
		if (number >= 600 && number <= 1200) {
			map.setZoom(4);
		}
		if (number >= 300 && number <= 600) {
			map.setZoom(5);
		}
		if (number >= 150 && number <= 300) {
			map.setZoom(6);
		}
		if (number >= 75 && number <= 150) {
			map.setZoom(7);
		}
		if (number >= 38 && number <= 75) {
			map.setZoom(8);
		}
		if (number >= 16 && number <= 38) {
			map.setZoom(9);
		}
		if (number >= 8 && number <= 16) {
			map.setZoom(10);
		}
		if (number >= 4 && number <= 8) {
			map.setZoom(11);
		}
		if (number >= 2 && number <= 4) {
			map.setZoom(12);
		}
		if (number >= 1 && number <= 2) {
			map.setZoom(13);
		}
		if (number >= 0 && number <= 1) {
			map.setZoom(14);
		}
	}
	
</script>

  <script>
    var _gaq=[['_setAccount','UA-6102405-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
</body>
</html>